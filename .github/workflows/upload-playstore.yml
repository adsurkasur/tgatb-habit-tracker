name: Upload Play Store AAB

on:
  workflow_dispatch: {}
  push:
    tags: ['v*']

jobs:
  upload-playstore:
    name: Upload AAB to Play (internal)
    runs-on: ubuntu-latest
    concurrency:
      group: upload-playstore-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor project
        run: npx cap sync android

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      - name: Append signing properties
        run: |
          printf '\nstoreFile=release.keystore\nkeyAlias=${{ secrets.ANDROID_KEY_ALIAS }}\n' >> android/gradle.properties

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Verify keystore
        run: keytool -list -v -keystore android/app/release.keystore -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" || true

      - name: Prepare Play service account JSON
        id: prepare_play_json
        run: |
          if [ -n "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" ]; then
            echo "Decoding base64 service account"
            echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > /tmp/play.json
          else
            echo "Writing raw JSON service account"
            printf '%s' "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > /tmp/play.json
          fi
          echo "json<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/play.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Debug gradle properties (for CI troubleshooting)
        run: |
          echo "PWD: $(pwd)"
          echo "Listing android dir:" ; ls -la android || true
          echo "Root gradle.properties (root):" ; sed -n '1,200p' gradle.properties || true
          echo "Android gradle.properties (android/):" ; sed -n '1,200p' android/gradle.properties || true
          echo "Check for android.useAndroidX:" ; grep -n 'android.useAndroidX' android/gradle.properties || true

      - name: Normalize gradle properties (remove BOM & CRLF)
        run: |
          echo "Removing BOM and normalizing line endings in android/gradle.properties"
          python - <<'PY'
    import io
    p='android/gradle.properties'
    b=open(p,'rb').read()
    b=b.lstrip(b'\xef\xbb\xbf')
    b=b.replace(b'\r\n',b'\n')
    open(p,'wb').write(b)
    print(open(p,'rb').read(160))
    PY
          echo "After normalization content:" ; sed -n '1,200p' android/gradle.properties || true

      - name: Build AAB
        run: ./gradlew --no-daemon bundleRelease --stacktrace --info
        working-directory: android
        env:
          ORG_GRADLE_PROJECT_androidKeystorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_androidKeyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload AAB to Play Internal track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ steps.prepare_play_json.outputs.json }}
          packageName: com.tgatb.habittracker
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: internal

      - name: List generated AAB
        run: ls -l android/app/build/outputs/bundle/release
