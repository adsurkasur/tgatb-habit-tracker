name: Upload Play Store AAB

on:
  workflow_dispatch: {}
  push:
    tags: ['v*']

jobs:
  upload-playstore:
    name: Upload AAB to Play (internal)
    runs-on: ubuntu-latest
    concurrency:
      group: upload-playstore-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Remove BOM from gradle.properties
        run: |
          # Remove UTF-8 BOM if present (first 3 bytes EF BB BF)
          FILE="android/gradle.properties"
          if [ -f "$FILE" ]; then
            sed -i '1s/^\xEF\xBB\xBF//' "$FILE"
            echo "gradle.properties first bytes:"
            head -c 30 "$FILE" | xxd
          fi

      - name: Decode Google Services JSON
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > android/app/google-services.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor project
        run: npx cap sync android

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      - name: Append signing properties
        run: |
          printf '\nstoreFile=release.keystore\nkeyAlias=${{ secrets.ANDROID_KEY_ALIAS }}\n' >> android/gradle.properties

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Verify keystore
        run: keytool -list -v -keystore android/app/release.keystore -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" || true

      - name: Prepare Play service account JSON
        run: |
          if [ -n "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" ]; then
            echo "Decoding base64 service account"
            echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > /tmp/play-service-account.json
          else
            echo "Writing raw JSON service account"
            printf '%s' "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > /tmp/play-service-account.json
          fi

      - name: Build AAB
        run: ./gradlew --no-daemon bundleRelease --stacktrace --info
        working-directory: android
        env:
          ORG_GRADLE_PROJECT_androidKeystorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_androidKeyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload AAB as artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Upload AAB to Play Internal track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: /tmp/play-service-account.json
          packageName: com.tgatb.habittracker
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          mappingFile: android/app/build/outputs/mapping/release/mapping.txt
          debugSymbols: android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib
